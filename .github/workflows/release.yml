name: Release

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Skip publishing (still runs version PR step)'
        type: boolean
        default: false

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # push tags / create releases (and commit in version PR)
      pull-requests: write # open/update version PR
      id-token: write # npm trusted publishing / provenance
    env:
      DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry-run || false }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-env
        with:
          registry-url: 'https://registry.npmjs.org'

      - name: Configure Git identity
        uses: ./.github/actions/configure-git

      # This action handles:
      # - open/update version PR when changesets exist
      # - publish on master after that PR is merged (unless dry-run)
      - name: Version or Publish via Changesets
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm changeset:version
          publish: ${{ env.DRY_RUN == 'true' && '' || 'pnpm changeset:publish' }}
          commit: 'ci: version packages'
          title: 'ci: version packages'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log outcome
        run: |
          echo "published=${{ steps.changesets.outputs.published }}"
          echo "pullRequestNumber=${{ steps.changesets.outputs.pullRequestNumber }}"
          echo "publishedPackages=${{ steps.changesets.outputs.publishedPackages }}"

          if [ "${{ env.DRY_RUN }}" = "true" ]; then
            echo "Dry run enabled: publish step was skipped."
          fi

          if [ "${{ steps.changesets.outputs.published }}" = "true" ]; then
            echo "Packages were published."
          elif [ -n "${{ steps.changesets.outputs.pullRequestNumber }}" ]; then
            echo "Version PR created/updated: #${{ steps.changesets.outputs.pullRequestNumber }}"
          else
            echo "No changesets found; nothing to do."
          fi

      # Create GitHub releases only when publishing happened
      - name: Create GitHub Releases
        if: steps.changesets.outputs.published == 'true' && env.DRY_RUN == 'false'
        run: |
          set -euo pipefail

          echo '${{ steps.changesets.outputs.publishedPackages }}' \
            | jq -c '.[]' \
            | while read -r pkg; do
                name=$(echo "$pkg" | jq -r '.name')
                version=$(echo "$pkg" | jq -r '.version')
                tag="${name}@${version}"

                # idempotent: skip if release already exists
                if gh release view "$tag" >/dev/null 2>&1; then
                  echo "Release $tag already exists; skipping."
                  continue
                fi

                # Best-effort notes: use a generic message (avoid brittle changelog parsing)
                notes="Release ${tag}"

                echo "Creating GitHub release $tag"
                gh release create "$tag" --title "$tag" --notes "$notes" --verify-tag
              done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate npm availability
        if: steps.changesets.outputs.published == 'true' && env.DRY_RUN == 'false'
        run: |
          set -euo pipefail

          echo '${{ steps.changesets.outputs.publishedPackages }}' \
            | jq -c '.[]' \
            | while read -r pkg; do
                name=$(echo "$pkg" | jq -r '.name')
                version=$(echo "$pkg" | jq -r '.version')

                echo "Checking $name@$version ..."
                for i in 1 2 3 4 5; do
                  if npm view "$name@$version" version >/dev/null 2>&1; then
                    echo "OK: $name@$version is available."
                    break
                  fi
                  echo "Not yet visible (attempt $i/5). Waiting..."
                  sleep 5
                done
              done
        timeout-minutes: 5
