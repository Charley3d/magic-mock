const e=e=>/\.(jpe?g|png|gif|svg|webp|ico|mp4|mp3|woff2?|ttf|css|js)$/i.test(e.pathname),t=e=>e.pathname.includes(`/api/__`),n=e=>{try{return typeof e==`string`?new URL(e,location.href):e instanceof URL?e:e instanceof Request?new URL(e.url,location.href):null}catch{return null}},r=e=>[`GET`,`POST`,`PUT`,`DELETE`].includes(e.toUpperCase()),i=(e,t,n)=>`${e.toUpperCase()}::${t}::${n||``}`,a=e=>{let t={};for(let[n,r]of e.entries())typeof r==`string`?t[n]=r:t[n]={_file:!0,name:r.name||`blob`,size:r.size,type:r.type};return JSON.stringify(t)},o=(e,t=1048576)=>{try{let n=JSON.parse(e),r=0,i=e=>typeof e==`object`&&!!e&&`_file`in e&&e._file===!0&&`size`in e&&typeof e.size==`number`,a=e=>{i(e)?r+=e.size:typeof e==`object`&&e&&Object.values(e).forEach(a)};if(a(n),r>0)return Math.round(r/t*1e3)}catch{}return 0};function s(e){if(e)return e instanceof FormData?a(e):e instanceof Document?new XMLSerializer().serializeToString(e):typeof e==`string`?e:String(e)}function c(n,i){return!!(n&&!e(n)&&!t(n)&&r(i))}const l=window.fetch,u=window.XMLHttpRequest,d=()=>localStorage.getItem(`magic-mock-recording`)===`true`,f=()=>localStorage.getItem(`magic-mock-mocking`)===`true`;var p=class{constructor(e=5e4){this.sizeLimit=e}async get(e,t){let{url:n,method:r,body:a}=t,s=i(r,n,a),c=localStorage.getItem(s);if(!c)throw Error(`Cache not found`);let l=JSON.parse(c);if(console.log(`ðŸ”„ Serving from cache:`,r,n),a){let e=o(a);e>0&&(console.log(`â±ï¸ Simulating upload delay: ${e}ms`),await new Promise(t=>setTimeout(t,e)))}return typeof l.response==`string`?new Response(l.response,{status:l.status,headers:l.headers}):new Response(JSON.stringify(l.response),{status:l.status,headers:l.headers})}async set(e,t){let{url:n,method:r,body:a,data:o,response:s}=t;if(this.sizeLimit>0&&a){let e=new Blob([a]).size;if(e>this.sizeLimit){console.warn(`âš ï¸ Body too large to cache (${e} bytes, limit: ${this.sizeLimit})`);return}}let c=s?.status,l=s?s.headers:[],u=i(r,n,a),d={url:n,method:r,body:a,response:o,status:c,headers:Object.fromEntries(l.entries())};localStorage.setItem(u,JSON.stringify(d)),console.log(`âœ… Cached with Local Storage:`,r,n)}};new p;const m=()=>new p,h=m();function g(){window.fetch=async function(...e){let[t,r]=e,i=r?.method??(t instanceof Request?t.method:`GET`),a;r?.body?a=s(r.body):t instanceof Request&&t.body&&(a=s(await t.clone().text()));let o=n(t),u=await _(o,i,a);if(u)return u;let f=await l(...e);return d()&&o&&c(o,i)&&f.ok&&await v(o,f,i,a),f}}async function _(e,t,n){if(!f()||!c(e,t))return null;try{return await h.get(l,{url:e.href,method:t,body:n})}catch{return console.log(`âŒ Cache miss:`,t,e.href),null}}async function v(e,t,n,r){let i=t.clone(),a=t.headers.get(`content-type`),o;o=a?.includes(`application/json`)?await i.json():await i.text();try{await h.set(l,{url:e.href,method:n,body:r,data:o,response:t})}catch(e){console.error(`Error while storing response`,e)}}const y=m();function b(){let e=u.prototype.open,t=u.prototype.send;u.prototype.open=function(t,n,r=!0,i,a){return this._method=t,this._url=n,e.call(this,t,n,r,i,a)},u.prototype.send=function(e){let t=this,i=t._method,a=t._url,o=s(e),u=n(a);if(f()&&c(u,i)){y.get(l,{url:u.href,method:i,body:o}).then(async e=>{console.log(`ðŸ”„ Serving XHR from cache:`,i,u.href);let n=await e.text(),r=e.status,a=e.statusText;Reflect.defineProperty(t,`responseText`,{writable:!0,value:n}),Reflect.defineProperty(t,`response`,{writable:!0,value:n}),Reflect.defineProperty(t,`status`,{writable:!0,value:r}),Reflect.defineProperty(t,`statusText`,{writable:!0,value:a}),Reflect.defineProperty(t,`readyState`,{writable:!0,value:4});let o=new Event(`readystatechange`);t.dispatchEvent(o);let s=new ProgressEvent(`load`,{lengthComputable:!0,loaded:n.length,total:n.length});t.dispatchEvent(s);let c=new ProgressEvent(`loadend`,{lengthComputable:!0,loaded:n.length,total:n.length});t.dispatchEvent(c)}).catch(()=>{console.log(`âŒ XHR Cache miss:`,i,a),r(t,i,a,o,e)});return}r(t,i,a,o,e)};function r(e,r,i,a,o){return e.addEventListener(`readystatechange`,function(){let t=n(i);e.readyState===4&&d()&&c(t,r)&&e.status>=200&&e.status<300&&x(t,e,r,a)}),t.call(e,o)}}async function x(e,t,n,r){let i=t.getResponseHeader(`content-type`),a;if(i?.includes(`application/json`))try{a=JSON.parse(t.responseText)}catch{a=t.responseText}else a=t.responseText;let o=new Headers,s=t.getAllResponseHeaders();s&&s.split(`\r
`).forEach(e=>{let[t,n]=e.split(`: `);t&&n&&o.set(t,n)});let c=new Response(t.responseText,{status:t.status,statusText:t.statusText,headers:o});try{await y.set(l,{url:e.href,method:n,body:r,data:a,response:c})}catch(e){console.error(`Error while storing XHR response`,e)}}function S(){let e=document.createElement(`div`);e.style.cssText=`position: fixed; top: 10px; right: 10px; z-index: 99999; display: flex; gap: 10px;`;let t=document.createElement(`button`);t.textContent=d()?`â¹ Recording...`:`âº Record`,t.style.cssText=`padding: 10px 15px; background: ${d()?`#ff0000`:`#ff4444`}; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);`;let n=document.createElement(`button`);n.textContent=f()?`âœ“ Mocking`:`ðŸ”„ Mock`,n.style.cssText=`padding: 10px 15px; background: ${f()?`#0000ff`:`#4444ff`}; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);`,t.onclick=()=>{let e=!d();localStorage.setItem(`magic-mock-recording`,e.toString()),t.style.background=d()?`#ff0000`:`#ff4444`,t.textContent=d()?`â¹ Recording...`:`âº Record`,console.log(`Recording:`,d())},n.onclick=()=>{let e=!f();localStorage.setItem(`magic-mock-mocking`,e.toString()),n.style.background=e?`#0000ff`:`#4444ff`,n.textContent=e?`âœ“ Mocking`:`ðŸ”„ Mock`,console.log(`Mocking:`,e)},e.appendChild(t),e.appendChild(n),document.body.appendChild(e)}function C(){g(),b(),document.readyState===`loading`?document.addEventListener(`DOMContentLoaded`,S):S()}export{C as initMagicMock};
//# sourceMappingURL=client-script.js.map